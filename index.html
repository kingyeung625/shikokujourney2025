<script>
    // âœ… æ‚¨çš„å°ˆå±¬ Google Sheet é€£çµ
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/1_BTEVWitKQq1BGMwpYy8gh0QVEDT0YojntWTfynFeOg/pub?output=csv'; 

    let itinerary = [];
    let currentDayIdx = 0;

    async function loadData() {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '<div style="text-align:center; padding:30px; color:#666;"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥è¡Œç¨‹ä¸­...</div>';
        
        try {
            const res = await fetch(CSV_URL);
            if (!res.ok) throw new Error("Network response was not ok");
            const text = await res.text();
            parseCSV(text);
        } catch(e) {
            console.error(e);
            timeline.innerHTML = '<div style="text-align:center; padding:20px; color:red;">è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– Google Sheet è¨­å®šã€‚</div>';
        }
    }

    function parseCSV(text) {
        const rows = text.trim().split('\n');
        const temp = {};
        
        // å¾ç¬¬ 2 è¡Œé–‹å§‹è®€ (è·³éæ¨™é¡Œ)
        for (let i = 1; i < rows.length; i++) {
            const cols = parseCSVRow(rows[i]);
            if (cols.length < 2) continue; 

            // --- æ¬„ä½å°æ‡‰ (æ ¹æ“šæœ€æ–°çš„ CSV çµæ§‹) ---
            // 0:Date, 1:Time, 2:End, 3:Type, 4:Title, 5:DESC(é•·æ–‡), 6:Link, 7:Mapcode, 8:Lat, 9:Lon, 10:DriveTime
            
            const rawDate = cols[0] ? cols[0].trim() : "";
            const time = cols[1] ? cols[1].trim() : "";
            const endTime = cols[2] ? cols[2].trim() : "";
            const typeRaw = cols[3] ? cols[3].trim() : "";
            const title = cols[4] ? cols[4].trim() : "";
            const desc = cols[5] ? cols[5].trim() : ""; // é€™è£¡ç¾åœ¨æ˜¯é•·æ–‡ç« 
            const link = cols[6] ? cols[6].trim() : "";
            const mapcode = cols[7] ? cols[7].trim() : "";
            const driveTime = cols[10] ? cols[10].trim() : ""; // é§•é§›æ™‚é–“åœ¨ç¬¬ 11 æ¬„ (Index 10)

            if (!rawDate) continue;
            const dateKey = rawDate.split(' ')[0];

            // åœ–ç¤ºèˆ‡æ¨£å¼
            let icon = "ğŸ“";
            let grad = "grad-travel";
            
            if (typeRaw.includes("travel") || title.includes("ç§Ÿè»Š")) { icon = "ğŸš—"; grad = "grad-travel"; }
            else if (typeRaw.includes("sight")) { icon = "ğŸ“·"; grad = "grad-nature"; }
            else if (typeRaw.includes("shop")) { icon = "ğŸ›ï¸"; grad = "grad-shop"; }
            else if (typeRaw.includes("food")) { icon = "ğŸ½ï¸"; grad = "grad-food"; }
            else if (typeRaw.includes("hotel")) { icon = "ğŸ›ï¸"; grad = "grad-hotel"; }
            else if (typeRaw.includes("rest") || title.includes("SA")) { icon = "â˜•ï¸"; grad = "grad-rest"; }

            if (!temp[dateKey]) {
                temp[dateKey] = { date: dateKey, fullDate: rawDate, events: [] };
            }

            temp[dateKey].events.push({
                time: time,
                end: endTime,
                title: title,
                desc: desc,
                link: link,
                mapcode: mapcode,
                icon: icon,
                gradient: grad,
                drive: driveTime
            });
        }

        itinerary = Object.values(temp);
        renderNav();
        renderTimeline();
    }

    function parseCSVRow(row) {
        const res = []; let cur = ''; let inQ = false;
        for (let c of row) {
            if (c === '"') inQ = !inQ;
            else if (c === ',' && !inQ) { res.push(cur); cur = ''; }
            else cur += c;
        }
        res.push(cur);
        return res;
    }

    function renderNav() {
        const nav = document.getElementById('nav-tabs');
        nav.innerHTML = '';
        itinerary.forEach((day, i) => {
            const btn = document.createElement('button');
            btn.className = `date-btn ${i === currentDayIdx ? 'active' : ''}`;
            btn.innerHTML = day.date;
            btn.onclick = () => { currentDayIdx = i; renderNav(); renderTimeline(); };
            btn.style.cssText = `margin:0 5px; padding:10px 16px; border:none; border-radius:20px; background:${i===currentDayIdx?'#0f4c81':'#eee'}; color:${i===currentDayIdx?'#fff':'#666'}; font-weight:bold; cursor:pointer;`;
            nav.appendChild(btn);
        });
    }

    function renderTimeline() {
        const con = document.getElementById('timeline');
        con.innerHTML = '';
        const day = itinerary[currentDayIdx];
        if (!day) return;

        con.innerHTML += `<h2 style="margin:10px 5px 20px 5px; color:#2c3e50;">${day.fullDate}</h2>`;

        day.events.forEach((item, idx) => {
            // é§•é§›æ™‚é–“æ¨™ç±¤
            let driveHtml = item.drive && item.drive !== '-' ? 
                `<div style="position:absolute; top:-15px; left:50%; transform:translateX(-50%); background:#fff; border:1px solid #ccc; color:#666; padding:2px 8px; border-radius:10px; font-size:0.7rem; white-space:nowrap; z-index:5; display:flex; align-items:center; gap:3px;"><i class="fa-solid fa-car-side"></i> ${item.drive}</div>` : '';

            // Mapcode & é€£çµ
            let mapBtn = item.mapcode ? `<div style="margin-top:12px; background:#f1f2f6; color:#333; padding:6px 10px; border-radius:6px; font-size:0.85rem; font-family:monospace; display:inline-block; font-weight:bold;"><i class="fa-solid fa-location-dot"></i> ${item.mapcode}</div>` : '';
            let linkBtn = item.link ? `<a href="${item.link}" target="_blank" style="margin-top:12px; margin-left:8px; background:#e3f2fd; color:#1565c0; padding:6px 10px; border-radius:6px; font-size:0.85rem; text-decoration:none; display:inline-block; font-weight:bold;">ğŸ”— è©³æƒ…/é ç´„</a>` : '';

            // æ¨£å¼è¨­å®š
            let cardStyle = "";
            if(item.gradient === 'grad-rest') cardStyle = "background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); color:#1b5e20;"; 
            else if(item.gradient === 'grad-travel') cardStyle = "background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);";
            else if(item.gradient === 'grad-nature') cardStyle = "background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);";
            else if(item.gradient === 'grad-food') cardStyle = "background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);";
            else if(item.gradient === 'grad-shop') cardStyle = "background: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%);";
            else if(item.gradient === 'grad-hotel') cardStyle = "background: linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%); color:white;";

            const html = `
                <div class="timeline-row" style="display:flex; padding-bottom:25px;">
                    <div class="time-col" style="flex:0 0 60px; text-align:right; padding-right:10px; font-size:0.9rem; font-weight:bold; color:#555;">
                        <div>${item.time}</div>
                        <div style="font-size:0.8rem; color:#999; margin-top:4px;">${item.end}</div>
                    </div>
                    
                    <div class="line-col" style="flex:0 0 20px; position:relative; display:flex; justify-content:center;">
                        <div style="position:absolute; top:10px; bottom:-25px; width:2px; background:#e0e0e0;"></div>
                        ${idx > 0 ? driveHtml : ''}
                        <div style="width:14px; height:14px; background:${item.gradient==='grad-rest'?'#4caf50':'#0f4c81'}; border-radius:50%; border:3px solid #fff; box-shadow:0 0 0 2px #e0e0e0; position:relative; z-index:2; margin-top:5px;"></div>
                    </div>

                    <div class="content-col" style="flex:1; padding-left:12px;">
                        <div class="card" style="border-radius:16px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08); background:#fff;">
                            <div class="visual-header" style="padding:15px; ${cardStyle} display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-size:1.8rem;">${item.icon}</div>
                                <h3 style="margin:0; font-size:1.15rem; flex:1; margin-left:10px; font-weight:bold;">${item.title}</h3>
                            </div>
                            <div class="card-body" style="padding:18px;">
                                <div style="color:#333; font-size:0.95rem; line-height:1.7; white-space:pre-wrap; text-align:justify;">${item.desc}</div>
                                ${mapBtn} ${linkBtn}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            con.innerHTML += html;
        });
    }
    
    loadData();
</script>
