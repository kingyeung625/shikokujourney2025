<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 å†¬ä¹‹å››åœ‹ â€¢ è‡ªé§•å°èˆª</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #0f4c81;       /* ç¶“å…¸è— */
            --bg: #f0f2f5;            /* æ·ºç°èƒŒæ™¯ */
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #555555;
            --radius: 16px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 100px; /* é ç•™åº•éƒ¨å·¥å…·åˆ—ç©ºé–“ */
            line-height: 1.6;
        }

        /* --- Header & GPS --- */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .header-title h1 { margin: 0; font-size: 1.2rem; font-weight: 900; color: var(--primary); }
        .header-title p { margin: 2px 0 0; font-size: 0.75rem; color: #888; }

        .gps-widget {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            color: #fff; padding: 6px 12px; border-radius: 20px;
            font-size: 0.8rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(142, 197, 252, 0.4);
            display: flex; align-items: center; gap: 5px;
        }

        /* --- Date Navigation --- */
        .date-nav {
            background: #fff; padding: 10px 0; overflow-x: auto;
            white-space: nowrap; border-bottom: 1px solid #eee;
            position: sticky; top: 65px; z-index: 990;
        }
        .date-btn {
            display: inline-block; margin: 0 5px; padding: 10px 18px;
            border: none; border-radius: 20px;
            background: #f0f2f5; color: #666;
            font-weight: bold; font-size: 0.95rem;
            cursor: pointer; transition: all 0.2s;
        }
        .date-btn:first-child { margin-left: 15px; }
        .date-btn.active {
            background: var(--primary); color: #fff;
            box-shadow: 0 4px 8px rgba(15, 76, 129, 0.3);
        }

        /* --- Timeline Layout --- */
        .container { max-width: 800px; margin: 0 auto; padding: 20px 15px; }
        .day-title { margin: 10px 5px 25px 5px; color: var(--text-main); font-size: 1.5rem; font-weight: 800; border-left: 5px solid var(--primary); padding-left: 15px; }

        .timeline-row { display: flex; padding-bottom: 25px; position: relative; }

        /* Time Column */
        .time-col {
            flex: 0 0 60px; text-align: right; padding-right: 12px;
            font-size: 0.9rem; font-weight: bold; color: var(--text-sub); padding-top: 5px;
        }
        .end-time { font-size: 0.75rem; color: #999; margin-top: 4px; display: block; font-weight: normal; }

        /* Line Column */
        .line-col {
            flex: 0 0 20px; position: relative; display: flex; justify-content: center;
        }
        .line-bar {
            position: absolute; top: 15px; bottom: -25px; width: 2px; background: #e0e0e0; z-index: 0;
        }
        .line-dot {
            width: 14px; height: 14px; border-radius: 50%; border: 3px solid #fff;
            position: relative; z-index: 2; margin-top: 8px;
            box-shadow: 0 0 0 2px #e0e0e0;
        }
        .timeline-row:last-child .line-bar { display: none; }

        /* Drive Time Badge */
        .drive-badge {
            position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
            background: #fff; border: 1px solid #ccc; color: #666;
            padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;
            white-space: nowrap; z-index: 5; display: flex; align-items: center; gap: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Content Column */
        .content-col { flex: 1; padding-left: 12px; min-width: 0; }

        /* Card Design */
        .card {
            background: var(--card-bg); border-radius: var(--radius);
            overflow: hidden; box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.99); }

        .visual-header {
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            color: #333;
        }
        .card-icon { font-size: 1.8rem; }
        .card-title { margin: 0; font-size: 1.15rem; font-weight: 800; flex: 1; margin-left: 12px; line-height: 1.3; }

        .card-body { padding: 18px; padding-top: 10px; }
        
        /* Description Text Style */
        .desc-text {
            color: #333; font-size: 0.95rem; line-height: 1.7;
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
            text-align: justify;
        }

        /* Buttons */
        .action-area { margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap; }
        
        .btn-tag {
            padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-family: monospace;
            text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 6px;
            transition: opacity 0.2s;
        }
        .btn-mapcode { background: #2c3e50; color: #fff; cursor: pointer; }
        .btn-link { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
        .btn-nav { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; margin-left: auto; }

        /* Gradients */
        .grad-travel { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .grad-nature { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .grad-food { background: linear-gradient(120deg, #f6d365 0%, #fda085 100%); }
        .grad-shop { background: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); }
        .grad-hotel { background: linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%); color: white !important; }
        .grad-hotel .card-title { color: white; }
        .grad-rest { background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); color: #1b5e20; }

        /* Toolkit Bar (Bottom) */
        .toolkit-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.1); padding: 10px 20px; border-radius: 50px;
            display: flex; justify-content: space-between; z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .tool-btn {
            background: none; border: none; cursor: pointer; color: #555;
            font-size: 0.7rem; font-weight: bold; display: flex; flex-direction: column; align-items: center;
        }
        .tool-icon { font-size: 1.4rem; margin-bottom: 2px; }

        /* Mapcode Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 85%; max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .big-code { font-size: 2.5rem; font-weight: 900; color: var(--primary); margin: 15px 0; font-family: monospace; letter-spacing: 2px; }
    </style>
</head>
<body>

<header>
    <div class="header-title">
        <h1>2025 å†¬ä¹‹å››åœ‹</h1>
        <p>è‡ªé§• â€¢ æº«æ³‰ â€¢ ç¾é£Ÿä¹‹æ—…</p>
    </div>
    <div class="gps-widget" onclick="getGPSWeather()" id="gpsWidget">
        <i class="fa-solid fa-location-crosshairs"></i> <span>å®šä½å¤©æ°£</span>
    </div>
</header>

<div class="date-nav" id="nav-tabs"></div>

<div class="container" id="timeline">
    <div style="text-align:center; padding:50px; color:#888;">
        <i class="fa-solid fa-spinner fa-spin fa-2x"></i><br><br>è¼‰å…¥è¡Œç¨‹ä¸­...
    </div>
</div>

<div class="toolkit-bar">
    <button class="tool-btn" onclick="searchNearby('gas station')"><span class="tool-icon">â›½</span>æ²¹ç«™</button>
    <button class="tool-btn" onclick="searchNearby('parking')"><span class="tool-icon">ğŸ…¿ï¸</span>åœè»Š</button>
    <button class="tool-btn" onclick="searchNearby('convenience store')"><span class="tool-icon">ğŸª</span>ä¾¿åˆ©åº—</button>
    <button class="tool-btn" onclick="location.reload()"><span class="tool-icon">ğŸ”„</span>æ›´æ–°</button>
</div>

<div class="modal" id="mapcodeModal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 style="margin:0; color:#888;">MAPCODE</h3>
        <div class="big-code" id="bigMapcodeText"></div>
        <p style="color:#999; font-size:0.85rem; margin:0;">è«‹è¼¸å…¥è‡³è»Šè¼‰å°èˆªç³»çµ±</p>
        <button onclick="document.getElementById('mapcodeModal').style.display='none'" style="margin-top:20px; padding:10px 30px; background:#f0f2f5; border:none; border-radius:20px; font-weight:bold; cursor:pointer;">é—œé–‰</button>
    </div>
</div>

<script>
    // âœ… æ‚¨çš„ Google Sheet CSV é€£çµ (å·²è¨­å®šç‚ºæ‚¨æä¾›çš„æª”æ¡ˆ)
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/1_BTEVWitKQq1BGMwpYy8gh0QVEDT0YojntWTfynFeOg/pub?output=csv'; 

    let itinerary = [];
    let currentDayIdx = 0;

    // 1. è®€å–èˆ‡è§£æè³‡æ–™
    async function loadData() {
        try {
            const res = await fetch(CSV_URL);
            if (!res.ok) throw new Error("ç„¡æ³•è®€å– Google Sheet");
            const text = await res.text();
            parseCSV(text);
        } catch(e) {
            console.error(e);
            document.getElementById('timeline').innerHTML = 
                `<div style="text-align:center; padding:30px; color:red;">
                    <i class="fa-solid fa-triangle-exclamation"></i><br>è®€å–å¤±æ•—<br>è«‹ç¢ºèªç¶²è·¯é€£ç·š
                </div>`;
        }
    }

    function parseCSV(text) {
        const rows = text.trim().split('\n');
        const temp = {};
        
        // å¾ç¬¬ 2 è¡Œé–‹å§‹è®€ (è·³éæ¨™é¡Œ)
        for (let i = 1; i < rows.length; i++) {
            const cols = parseCSVRow(rows[i]);
            if (cols.length < 2) continue;

            // --- æ¬„ä½å°æ‡‰ ---
            // 0:Date, 1:Time, 2:End, 3:Type, 4:Title, 5:Desc, 6:Link, 7:Mapcode, 8:Lat, 9:Lon, 10:DriveTime
            const rawDate = cols[0] ? cols[0].trim() : "";
            const time = cols[1] ? cols[1].trim() : "";
            const endTime = cols[2] ? cols[2].trim() : "";
            const typeRaw = cols[3] ? cols[3].trim() : "";
            const title = cols[4] ? cols[4].trim() : "";
            const desc = cols[5] ? cols[5].trim() : "";
            const link = cols[6] ? cols[6].trim() : "";
            const mapcode = cols[7] ? cols[7].trim() : "";
            const lat = cols[8] ? cols[8].trim() : "";
            const lon = cols[9] ? cols[9].trim() : "";
            const driveTime = cols[10] ? cols[10].trim() : "";

            if (!rawDate) continue;
            const dateKey = rawDate.split(' ')[0]; // å– "2025-12-10"

            // è‡ªå‹•æ¨£å¼åˆ¤æ–·
            let icon = "ğŸ“";
            let grad = "grad-travel";
            
            if (typeRaw.includes("travel") || title.includes("ç§Ÿè»Š") || title.includes("æ©Ÿå ´")) { icon = "ğŸš—"; grad = "grad-travel"; }
            else if (typeRaw.includes("sight")) { icon = "ğŸ“·"; grad = "grad-nature"; }
            else if (typeRaw.includes("shop")) { icon = "ğŸ›ï¸"; grad = "grad-shop"; }
            else if (typeRaw.includes("food")) { icon = "ğŸ½ï¸"; grad = "grad-food"; }
            else if (typeRaw.includes("hotel")) { icon = "ğŸ›ï¸"; grad = "grad-hotel"; }
            else if (typeRaw.includes("rest") || title.includes("SA")) { icon = "â˜•ï¸"; grad = "grad-rest"; }

            if (!temp[dateKey]) {
                temp[dateKey] = { date: dateKey, fullDate: rawDate, events: [] };
            }

            temp[dateKey].events.push({
                time, end: endTime, title, desc, link, mapcode, lat, lon, drive: driveTime,
                icon, gradient: grad
            });
        }

        itinerary = Object.values(temp);
        renderNav();
        renderTimeline();
    }

    function parseCSVRow(row) {
        const res = []; let cur = ''; let inQ = false;
        for (let c of row) {
            if (c === '"') inQ = !inQ;
            else if (c === ',' && !inQ) { res.push(cur); cur = ''; }
            else cur += c;
        }
        res.push(cur);
        return res;
    }

    // 2. æ¸²æŸ“å°èˆªåˆ—
    function renderNav() {
        const nav = document.getElementById('nav-tabs');
        nav.innerHTML = '';
        itinerary.forEach((day, i) => {
            const btn = document.createElement('button');
            btn.className = `date-btn ${i === currentDayIdx ? 'active' : ''}`;
            // åªé¡¯ç¤ºæ—¥æœŸå¾Œæ®µ (ä¾‹å¦‚ 12/10)
            btn.innerHTML = day.date.slice(5).replace('-','/'); 
            btn.onclick = () => { currentDayIdx = i; renderNav(); renderTimeline(); };
            nav.appendChild(btn);
        });
    }

    // 3. æ¸²æŸ“ä¸»æ™‚é–“è»¸
    function renderTimeline() {
        const con = document.getElementById('timeline');
        con.innerHTML = '';
        const day = itinerary[currentDayIdx];
        if (!day) return;

        con.innerHTML += `<div class="day-title">${day.fullDate}</div>`;

        day.events.forEach((item, idx) => {
            // é§•é§›æ™‚é–“æ¨™ç±¤ (Time to Next)
            let driveHtml = item.drive && item.drive !== '-' ? 
                `<div class="drive-badge"><i class="fa-solid fa-car-side"></i> ${item.drive}</div>` : '';

            // Mapcode æŒ‰éˆ•
            let mapBtn = item.mapcode ? 
                `<div class="btn-tag btn-mapcode" onclick="showBigMapcode('${item.mapcode}')">
                    <i class="fa-solid fa-location-dot"></i> ${item.mapcode}
                 </div>` : '';
            
            // é€£çµæŒ‰éˆ•
            let linkBtn = item.link ? 
                `<a href="${item.link}" target="_blank" class="btn-tag btn-link">
                    <i class="fa-solid fa-link"></i> è©³æƒ…
                 </a>` : '';

            // Google Maps å°èˆªé€£çµ
            let navLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}`;

            // å¤©æ°£è³‡æ–™ (è‹¥æœ‰ç¶“ç·¯åº¦)
            let weatherId = `weather-${currentDayIdx}-${idx}`;
            // è‹¥ç‚ºç•¶å¤©(è¿‘æœŸ)ï¼Œå¯å˜—è©¦å‘¼å«å¤©æ°£ APIï¼Œæ­¤è™•ç‚ºåŸºç¤çµæ§‹

            // åœ“é»é¡è‰²
            let dotColor = item.gradient === 'grad-rest' ? '#4caf50' : '#0f4c81';

            const html = `
                <div class="timeline-row">
                    <div class="time-col">
                        <div>${item.time}</div>
                        <span class="end-time">${item.end}</span>
                    </div>
                    
                    <div class="line-col">
                        <div class="line-bar"></div>
                        ${idx > 0 ? driveHtml : ''}
                        <div class="line-dot" style="background:${dotColor};"></div>
                    </div>

                    <div class="content-col">
                        <div class="card">
                            <div class="visual-header ${item.gradient}">
                                <div style="display:flex; align-items:center;">
                                    <div class="card-icon">${item.icon}</div>
                                    <h3 class="card-title">${item.title}</h3>
                                </div>
                                <a href="${navLink}" target="_blank" class="btn-tag btn-nav">
                                    <i class="fa-solid fa-paper-plane"></i> å°èˆª
                                </a>
                            </div>
                            <div class="card-body">
                                <div class="desc-text">${item.desc}</div>
                                <div class="action-area">
                                    ${mapBtn} ${linkBtn}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            con.innerHTML += html;
        });
    }

    // 4. å·¥å…·å‡½å¼
    function showBigMapcode(code) {
        document.getElementById('bigMapcodeText').innerText = code;
        document.getElementById('mapcodeModal').style.display = 'flex';
    }

    function searchNearby(keyword) {
        window.open(`https://www.google.com/maps/search/?api=1&query=${keyword}`, '_blank');
    }

    function getGPSWeather() {
        const btn = document.getElementById('gpsWidget');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> å®šä½ä¸­...';
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                    const data = await res.json();
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    let icon = 'â˜ï¸';
                    if(code <= 1) icon = 'â˜€ï¸'; else if(code <= 60) icon = 'â›…'; else icon = 'ğŸŒ§ï¸';
                    
                    btn.innerHTML = `${icon} ${temp}Â°C (ç›®å‰)`;
                } catch(e) {
                    btn.innerHTML = 'âš ï¸ æ°£è±¡å¤±æ•—';
                }
            }, () => {
                btn.innerHTML = 'ğŸš« ç„¡å®šä½æ¬Šé™';
                alert('è«‹å…è¨±ç€è¦½å™¨è®€å–ä½ç½®ä»¥é¡¯ç¤ºå¤©æ°£');
            });
        } else {
            alert("è£ç½®ä¸æ”¯æ´å®šä½");
        }
    }

    // å•Ÿå‹•
    loadData();
</script>

</body>
</html>
