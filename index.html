<script>
    // âœ… é€™æ˜¯æ ¹æ“šæ‚¨çš„æª”æ¡ˆ ID ç”¢ç”Ÿçš„å°ˆå±¬ CSV é€£çµ
    // (è«‹ç¢ºä¿æ‚¨å·²ç¶“åœ¨ Google Sheet æŒ‰ä¸‹ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€)
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/1_BTEVWitKQq1BGMwpYy8gh0QVEDT0YojntWTfynFeOg/pub?output=csv'; 

    let itinerary = [];
    let currentDayIdx = 0;

    // å•Ÿå‹•è¼‰å…¥
    async function loadData() {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '<div style="text-align:center; padding:30px; color:#666;"><i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨è®€å–é›²ç«¯è¡Œç¨‹...</div>';
        
        try {
            const res = await fetch(CSV_URL);
            if (!res.ok) throw new Error("Network response was not ok");
            const text = await res.text();
            parseCSV(text);
        } catch(e) {
            console.error(e);
            timeline.innerHTML = `
                <div style="text-align:center; padding:20px; color:red;">
                    <h3>âš ï¸ è®€å–å¤±æ•—</h3>
                    <p>è«‹ç¢ºèªæ‚¨çš„ Google Sheet æ˜¯å¦å·²<b>ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€</b>ï¼Ÿ</p>
                    <p style="font-size:0.8rem; color:#666;">(æª”æ¡ˆ > å…±ç”¨ > ç™¼å¸ƒåˆ°ç¶²è·¯ > é¸æ“‡ CSV > ç™¼å¸ƒ)</p>
                </div>`;
        }
    }

    // è§£æ CSV è³‡æ–™ (è‡ªå‹•å°æ‡‰æ‚¨çš„ä¸­æ–‡æ¬„ä½)
    function parseCSV(text) {
        const rows = text.trim().split('\n');
        const temp = {};
        
        // å¾ç¬¬ 2 è¡Œé–‹å§‹è®€ (è·³éæ¨™é¡Œåˆ—)
        for (let i = 1; i < rows.length; i++) {
            // è™•ç† CSV çš„é€—è™Ÿèˆ‡å¼•è™Ÿå•é¡Œ
            const cols = parseCSVRow(rows[i]);
            if (cols.length < 2) continue; // è·³éç©ºè¡Œ

            // --- æ¬„ä½å°æ‡‰ (æ ¹æ“šæ‚¨çš„è¡¨æ ¼é †åº) ---
            // 0:æ—¥æœŸ, 1:é–‹å§‹æ™‚é–“, 2:å®Œçµæ™‚é–“, 3:éœ€æ™‚, 4:ä½ç½®, 5:åœ°é»åç¨±, 6:äº‹é …é¡å‹, 7:äº‹é …å…§å®¹, 8:Mapcode
            
            const rawDate = cols[0] ? cols[0].trim() : "";  // ä¾‹: 12æœˆ10æ—¥ (ä¸‰)
            const time = cols[1] ? cols[1].trim() : "";
            const endTime = cols[2] ? cols[2].trim() : "";
            const title = cols[5] ? cols[5].trim() : "æœªå‘½åæ™¯é»"; // åœ°é»åç¨±
            const typeRaw = cols[6] ? cols[6].trim() : "";  // äº‹é …é¡å‹
            const desc = cols[7] ? cols[7].trim() : "";     // äº‹é …å…§å®¹
            const mapcode = cols[8] ? cols[8].trim() : "";  // Mapcode

            if (!rawDate) continue;

            // è™•ç†æ—¥æœŸä½œç‚º Key (å–ç©ºæ ¼å‰çš„éƒ¨åˆ†ï¼Œå¦‚ "12æœˆ10æ—¥")
            const dateKey = rawDate.split(' ')[0];

            // è‡ªå‹•åˆ¤æ–·é¡å‹èˆ‡åœ–ç¤º
            let icon = "ğŸ“";
            let grad = "grad-travel";
            
            if (typeRaw.includes("äº¤é€š") || title.includes("ç§Ÿè»Š") || title.includes("æ©Ÿå ´")) { icon = "ğŸš—"; grad = "grad-travel"; }
            else if (typeRaw.includes("æ™¯é»")) { icon = "ğŸ“·"; grad = "grad-nature"; }
            else if (typeRaw.includes("è³¼ç‰©")) { icon = "ğŸ›ï¸"; grad = "grad-shop"; }
            else if (typeRaw.includes("é¤é£²") || typeRaw.includes("ç¾é£Ÿ")) { icon = "ğŸ½ï¸"; grad = "grad-food"; }
            else if (typeRaw.includes("ä½å®¿") || typeRaw.includes("é…’åº—")) { icon = "ğŸ›ï¸"; grad = "grad-hotel"; }

            // å»ºç«‹è³‡æ–™çµæ§‹
            if (!temp[dateKey]) {
                temp[dateKey] = { date: dateKey, fullDate: rawDate, events: [] };
            }

            temp[dateKey].events.push({
                time: time,
                end: endTime,
                title: title,
                desc: desc,
                mapcode: mapcode,
                icon: icon,
                gradient: grad
            });
        }

        // è½‰ç‚ºé™£åˆ—ä¸¦æ¸²æŸ“
        itinerary = Object.values(temp);
        renderNav();
        renderTimeline();
    }

    // CSV åˆ†å‰²é‚è¼¯ (è™•ç† Excel è¼¸å‡ºçš„å¼•è™Ÿ)
    function parseCSVRow(row) {
        const res = [];
        let cur = '';
        let inQ = false;
        for (let c of row) {
            if (c === '"') inQ = !inQ;
            else if (c === ',' && !inQ) { res.push(cur); cur = ''; }
            else cur += c;
        }
        res.push(cur);
        return res;
    }

    // æ¸²æŸ“ä¸Šæ–¹æ—¥æœŸé¸å–®
    function renderNav() {
        const nav = document.getElementById('nav-tabs');
        nav.innerHTML = '';
        
        if (itinerary.length === 0) {
            nav.innerHTML = '<span style="padding:10px; color:#666;">ç„¡è³‡æ–™</span>';
            return;
        }

        itinerary.forEach((day, i) => {
            const btn = document.createElement('button');
            btn.className = `date-btn ${i === currentDayIdx ? 'active' : ''}`;
            
            // æ¨£å¼ï¼šè¢«é¸ä¸­æ™‚æ·±è—è‰²ï¼Œæœªé¸ä¸­æ™‚æ·ºç°
            btn.style.cssText = `
                margin: 0 5px; padding: 10px 18px; border: none; border-radius: 20px;
                background: ${i === currentDayIdx ? '#0f4c81' : '#f0f2f5'};
                color: ${i === currentDayIdx ? '#fff' : '#666'};
                font-weight: bold; font-size: 0.95rem;
                cursor: pointer; white-space: nowrap; transition: all 0.2s;
                box-shadow: ${i === currentDayIdx ? '0 4px 6px rgba(15, 76, 129, 0.2)' : 'none'};
            `;
            
            btn.innerHTML = day.date; // é¡¯ç¤º "12æœˆ10æ—¥"
            btn.onclick = () => { currentDayIdx = i; renderNav(); renderTimeline(); };
            nav.appendChild(btn);
        });
    }

    // æ¸²æŸ“ä¸»è¦è¡Œç¨‹å¡ç‰‡
    function renderTimeline() {
        const con = document.getElementById('timeline');
        con.innerHTML = '';
        const day = itinerary[currentDayIdx];
        
        if (!day) {
            con.innerHTML = '<div style="text-align:center; margin-top:50px;">æœ¬æ—¥ç„¡è¡Œç¨‹</div>';
            return;
        }

        // æ¨™é¡Œåˆ—
        con.innerHTML += `
            <div style="margin: 10px 5px 20px 5px;">
                <h2 style="margin:0; color:#2c3e50;">${day.fullDate}</h2>
            </div>
        `;

        day.events.forEach(item => {
            // åˆ¤æ–· Mapcode æŒ‰éˆ•
            let mapBtn = '';
            let navLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}`;
            
            if (item.mapcode && item.mapcode.trim() !== "") {
                mapBtn = `
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <div style="background:#f1f2f6; color:#2c3e50; padding:6px 12px; border-radius:8px; font-size:0.85rem; font-family:monospace; display:flex; align-items:center; gap:5px;">
                        <i class="fa-solid fa-car"></i> ${item.mapcode}
                    </div>
                </div>`;
            }

            // å¡ç‰‡ HTML
            const html = `
                <div class="timeline-row">
                    <div class="time-col">
                        <div class="start-time">${item.time}</div>
                        <div class="end-time">${item.end}</div>
                    </div>
                    <div class="line-col"><div class="dot"></div></div>
                    <div class="content-col">
                        <div class="card">
                            <div class="visual-header ${item.gradient}">
                                <div class="header-content">
                                    <div class="icon-box">${item.icon}</div>
                                </div>
                                <a href="${navLink}" target="_blank" class="btn-mini btn-map" style="position:absolute; top:15px; right:15px; text-decoration:none;">
                                    <i class="fa-solid fa-location-arrow"></i> å°èˆª
                                </a>
                            </div>
                            <div class="card-body">
                                <h3 class="card-title">${item.title}</h3>
                                <div class="long-desc">${item.desc}</div>
                                ${mapBtn}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            con.innerHTML += html;
        });
    }

    // åŸ·è¡Œ
    loadData();
</script>
