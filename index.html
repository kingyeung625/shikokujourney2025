<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 å†¬ä¹‹å››åœ‹ â€¢ å®Œç¾è¡Œç¨‹</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --radius: 12px;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #333; }
        
        /* Header */
        header { background: #fff; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary); }
        .weather-badge { font-size: 0.8rem; background: #e3f2fd; padding: 5px 10px; border-radius: 20px; color: #1565c0; font-weight: bold; display: flex; align-items: center; gap: 5px;}

        /* Date Nav */
        .nav-scroller { overflow-x: auto; white-space: nowrap; padding: 10px; background: #fff; border-bottom: 1px solid #eee; position: sticky; top: 60px; z-index: 90; }
        .date-chip { display: inline-block; padding: 8px 16px; margin-right: 8px; border-radius: 20px; background: #eee; color: #666; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .date-chip.active { background: var(--primary); color: #fff; }

        /* Timeline */
        .container { max-width: 800px; margin: 0 auto; padding: 20px 15px; }
        .day-header { font-size: 1.4rem; font-weight: 900; margin: 20px 0 10px; color: var(--primary); border-left: 5px solid var(--accent); padding-left: 10px; }
        
        .timeline-item { display: flex; margin-bottom: 20px; position: relative; }
        .time-col { min-width: 60px; text-align: right; padding-right: 15px; font-weight: bold; color: #555; font-size: 0.9rem; }
        .time-end { font-size: 0.75rem; color: #999; display: block; }
        
        .line-col { position: relative; display: flex; flex-direction: column; align-items: center; width: 20px; }
        .line { position: absolute; top: 10px; bottom: -30px; width: 2px; background: #ddd; z-index: 0; }
        .dot { width: 14px; height: 14px; background: var(--primary); border-radius: 50%; border: 3px solid #fff; z-index: 1; box-shadow: 0 0 0 2px #ddd; }
        .timeline-item:last-child .line { display: none; }

        /* Drive Time Badge */
        .drive-badge {
            position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
            background: #fff; border: 1px solid #ccc; color: #666;
            padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold;
            white-space: nowrap; z-index: 5; display: flex; align-items: center; gap: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .content-col { flex: 1; background: var(--card-bg); border-radius: var(--radius); padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        
        /* Card Types */
        .type-bar { height: 5px; width: 100%; position: absolute; top: 0; left: 0; }
        .type-travel .type-bar { background: #3498db; }
        .type-sight .type-bar { background: #2ecc71; }
        .type-food .type-bar { background: #e74c3c; }
        .type-shop .type-bar { background: #9b59b6; }
        .type-hotel .type-bar { background: #34495e; }

        .card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .title { font-size: 1.1rem; font-weight: 800; margin: 0; color: #333; }
        .weather-info { font-size: 0.75rem; color: #666; background: #f1f2f6; padding: 2px 6px; border-radius: 4px; white-space: nowrap; display: flex; align-items: center; gap: 4px;}

        .desc { font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 10px; }
        
        /* Info Boxes */
        .info-box { background: #f8f9fa; border-radius: 8px; padding: 8px 12px; margin-top: 8px; font-size: 0.85rem; border: 1px dashed #ccc; }
        .info-label { font-weight: bold; margin-right: 5px; }
        .hl-box { border-color: #ffcdd2; background: #ffebee; color: #c62828; } /* å¿…åƒå¿…è²· */
        .rm-box { border-color: #fff9c4; background: #fffde7; color: #f57f17; } /* å‘¨é‚Šæƒ…å ± */
        .pk-box { display: flex; align-items: center; gap: 5px; font-weight: 500;}
        .pk-free { color: #2e7d32; }
        .pk-paid { color: #d35400; }

        /* Action Buttons */
        .actions { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; border: none; cursor: pointer; }
        .btn-map { background: #e3f2fd; color: #1565c0; }
        .btn-link { background: #f3e5f5; color: #7b1fa2; }
        .mapcode-tag { font-family: monospace; background: #2c3e50; color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; cursor: pointer;}

        /* Bottom Bar */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0; z-index: 200; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .b-btn { background: none; border: none; font-size: 0.7rem; color: #666; display: flex; flex-direction: column; align-items: center; gap: 3px; cursor: pointer; }
        .b-btn i { font-size: 1.2rem; color: var(--primary); }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 16px; text-align: center; width: 80%; max-width: 300px; }
        .big-mapcode { font-size: 2rem; font-weight: 900; font-family: monospace; margin: 15px 0; color: var(--primary); }
    </style>
</head>
<body>

<header>
    <h1>2025 å†¬ä¹‹å››åœ‹</h1>
    <div class="weather-badge" id="currentWeather">
        <i class="fa-solid fa-location-crosshairs"></i> å®šä½ä¸­...
    </div>
</header>

<div class="nav-scroller" id="dateNav"></div>
<div class="container" id="timeline"></div>

<div class="bottom-bar">
    <button class="b-btn" onclick="searchNearby('gas station')"><i class="fa-solid fa-gas-pump"></i> æ²¹ç«™</button>
    <button class="b-btn" onclick="searchNearby('parking')"><i class="fa-solid fa-square-parking"></i> åœè»Š</button>
    <button class="b-btn" onclick="searchNearby('convenience store')"><i class="fa-solid fa-store"></i> ä¾¿åˆ©åº—</button>
    <button class="b-btn" onclick="searchNearby('supermarket')"><i class="fa-solid fa-basket-shopping"></i> è¶…å¸‚</button>
    <button class="b-btn" onclick="location.reload()"><i class="fa-solid fa-rotate-right"></i> æ›´æ–°</button>
</div>

<div class="modal" id="mcModal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3>Mapcode</h3>
        <div class="big-mapcode" id="modalMc"></div>
        <p style="color:#888; font-size:0.8rem;">è«‹è¼¸å…¥è‡³è»Šè¼‰å°èˆª</p>
        <button class="btn btn-map" onclick="document.getElementById('mcModal').style.display='none'" style="margin-top:10px; width:100%; justify-content: center;">é—œé–‰</button>
    </div>
</div>

<script>
    // âœ… æ‚¨çš„å°ˆå±¬ Google Sheet é€£çµ
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSCuzGVPMB4BXv6n10CKWedKgPvr2TJctTHIi_nCVWeM4k7XDoJyVJJVKYDsxODKJM3sWR3sRgAA1Gn/pub?gid=733036883&single=true&output=csv'; 

    let itinerary = [];
    let currentDayIdx = 0;

    async function init() {
        // 1. å–å¾— GPS å¤©æ°£
        getLiveWeather();
        
        // 2. è®€å–è¡Œç¨‹
        try {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            parseCSV(text);
        } catch (e) {
            document.getElementById('timeline').innerHTML = '<p style="text-align:center; padding:20px;">ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚</p>';
        }
    }

    function parseCSV(text) {
        const rows = text.trim().split('\n');
        const temp = {};
        
        // è·³éæ¨™é¡Œåˆ—ï¼Œå¾ç¬¬2è¡Œé–‹å§‹
        for (let i = 1; i < rows.length; i++) {
            const cols = parseCSVRow(rows[i]);
            if (cols.length < 5) continue;

            // å°æ‡‰æ¬„ä½ (ä¾æ“š CSV æª”æ¡ˆé †åº): 
            // 0:Date, 1:Time, 2:End, 3:Type, 4:Title, 5:Desc, 6:Link, 7:Mapcode, 
            // 8:ParkingType, 9:Highlights, 10:Remarks, 11:Lat, 12:Lon, 13:DriveTime
            const item = {
                date: cols[0], time: cols[1], end: cols[2], type: cols[3],
                title: cols[4], desc: cols[5], link: cols[6], mapcode: cols[7],
                parkingType: cols[8], highlight: cols[9], remark: cols[10],
                lat: cols[11], lon: cols[12], drive: cols[13]
            };

            // æ—¥æœŸæ ¼å¼çµ±ä¸€è™•ç† (ç›¸å®¹ 2025/12/10, 12/10/2025, 2025-12-10)
            // å¦‚æœæ—¥æœŸå­—ä¸²å«æœ‰ "/" å‰‡å˜—è©¦æ­£è¦åŒ–
            let safeDate = item.date;
            if (safeDate.includes('/')) {
                // æª¢æŸ¥æ˜¯å¦ç‚º MM/DD/YYYY æˆ– YYYY/MM/DD
                const parts = safeDate.split('/');
                if (parts[0].length === 4) { // YYYY/MM/DD
                    safeDate = `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
                } else { // MM/DD/YYYY
                    safeDate = `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
                }
            }
            item.date = safeDate;

            // æ—¥æœŸåˆ†çµ„
            if (!temp[item.date]) temp[item.date] = [];
            temp[item.date].push(item);
        }

        // è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
        itinerary = Object.keys(temp).sort().map(date => {
            const d = new Date(date);
            // æ‰‹å‹•æ ¼å¼åŒ–æ—¥æœŸï¼Œé¿å…ç€è¦½å™¨æ™‚å€å·®ç•°
            const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            const displayDate = `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ (${weekDays[d.getDay()]})`;
            
            return {
                date: date,
                displayDate: displayDate, 
                items: temp[date]
            };
        });

        renderNav();
        renderTimeline();
    }

    function parseCSVRow(row) {
        // è™•ç† CSV é€—è™Ÿèˆ‡å¼•è™Ÿ
        const res = []; let cur = ''; let inQ = false;
        for (let c of row) {
            if (c === '"') inQ = !inQ;
            else if (c === ',' && !inQ) { res.push(cur); cur = ''; }
            else cur += c;
        }
        res.push(cur);
        return res;
    }

    function renderNav() {
        const nav = document.getElementById('dateNav');
        nav.innerHTML = '';
        itinerary.forEach((day, idx) => {
            const chip = document.createElement('div');
            chip.className = `date-chip ${idx === currentDayIdx ? 'active' : ''}`;
            chip.innerText = day.displayDate;
            chip.onclick = () => { currentDayIdx = idx; renderNav(); renderTimeline(); };
            nav.appendChild(chip);
        });
    }

    function renderTimeline() {
        const con = document.getElementById('timeline');
        con.innerHTML = '';
        const day = itinerary[currentDayIdx];
        if (!day) return;

        con.innerHTML = `<div class="day-header">${day.displayDate}</div>`;

        day.items.forEach(async (item, idx) => {
            // é¡å‹æ¨£å¼
            let typeClass = 'type-travel';
            if (item.type.includes('sight')) typeClass = 'type-sight';
            if (item.type.includes('food')) typeClass = 'type-food';
            if (item.type.includes('shop')) typeClass = 'type-shop';
            if (item.type.includes('hotel')) typeClass = 'type-hotel';

            // é§•é§›æ™‚é–“ (é¡¯ç¤ºåœ¨ç·šæ¢ä¸Š)
            let driveHtml = item.drive && item.drive.trim() !== '-' && item.drive.trim() !== '' ? 
                `<div class="drive-badge"><i class="fa-solid fa-car-side"></i> ${item.drive}</div>` : '';

            // åœè»Šè³‡è¨Š (é¡è‰²é‚è¼¯)
            let parkingHtml = '';
            if (item.mapcode && item.mapcode.trim() !== '') {
                const isFree = item.parkingType.includes('å…è²»') || item.parkingType.includes('å°ˆç”¨');
                const pkClass = isFree ? 'pk-free' : 'pk-paid';
                const pkIcon = isFree ? 'fa-square-parking' : 'fa-circle-dollar-to-slot';
                parkingHtml = `<div class="info-box pk-box ${pkClass}"><i class="fa-solid ${pkIcon}"></i> <span>${item.parkingType || 'åœè»Šå ´'}</span></div>`;
            }

            // å¿…è²·/å‚™è¨» (å‘¨é‚Šè¨­æ–½)
            let hlHtml = item.highlight && item.highlight !== '-' ? `<div class="info-box hl-box"><i class="fa-solid fa-star"></i> ${item.highlight}</div>` : '';
            let rmHtml = item.remark && item.remark !== '-' ? `<div class="info-box rm-box"><i class="fa-solid fa-bell"></i> å‘¨é‚Šæƒ…å ±ï¼š${item.remark}</div>` : '';

            // Mapcode æŒ‰éˆ•
            let mcBtn = item.mapcode ? `<div class="mapcode-tag" onclick="showMc('${item.mapcode}')"><i class="fa-solid fa-car-side"></i> ${item.mapcode}</div>` : '';
            
            // å°èˆªé€£çµ
            let navUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.title)}`;

            // å–å¾—è©²æ™¯é»å¤©æ°£
            let weatherText = '';
            if(item.lat && item.lon && item.lat !== '-') {
                weatherText = `<span id="w-${idx}" class="weather-info"><i class="fa-solid fa-spinner fa-spin"></i></span>`;
                fetchSpotWeather(item.lat, item.lon, item.date, `w-${idx}`);
            }

            const html = `
                <div class="timeline-item">
                    <div class="line-col">
                        <div class="line"></div>
                        ${idx > 0 ? driveHtml : ''}
                        <div class="dot"></div>
                    </div>
                    <div class="time-col">
                        <div>${item.time}</div>
                        <span class="time-end">${item.end}</span>
                    </div>
                    <div class="content-col ${typeClass}">
                        <div class="type-bar"></div>
                        <div class="card-header">
                            <div class="title">${item.title}</div>
                            ${weatherText}
                        </div>
                        <div class="desc">${item.desc}</div>
                        ${hlHtml}
                        ${rmHtml}
                        ${parkingHtml}
                        <div class="actions">
                            ${mcBtn}
                            <a href="${navUrl}" target="_blank" class="btn btn-map"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a>
                            ${item.link ? `<a href="${item.link}" target="_blank" class="btn btn-link"><i class="fa-solid fa-link"></i> è©³æƒ…</a>` : ''}
                        </div>
                    </div>
                </div>
            `;
            con.innerHTML += html;
        });
    }

    // --- Weather API (Open-Meteo) ---
    async function fetchSpotWeather(lat, lon, dateStr, elementId) {
        // å›  Open-Meteo å…è²»ç‰ˆé™åˆ¶ï¼Œé€™è£¡åšç°¡å–®å»¶é²é¿å…è«‹æ±‚éå¤š
        await new Promise(r => setTimeout(r, Math.random() * 1000));
        
        try {
            // è™•ç†æ—¥æœŸæ ¼å¼ (API éœ€è¦ YYYY-MM-DD)
            // æ³¨æ„: å¦‚æœæ—¥æœŸè¶…éæœªä¾†14å¤©ï¼ŒOpen-Meteo Forecast ç„¡æ³•æä¾›ã€‚
            const targetDate = new Date(dateStr);
            const today = new Date();
            const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));

            // å¦‚æœæ—¥æœŸå¤ªé ï¼Œé¡¯ç¤º N/A
            if (diffDays > 14) {
                const el = document.getElementById(elementId);
                if(el) el.innerHTML = 'ğŸ“… é å ±æœªå‡º';
                return;
            }

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=${dateStr}&end_date=${dateStr}`;
            const res = await fetch(url);
            const data = await res.json();
            const tempMin = Math.round(data.daily.temperature_2m_min[0]);
            const tempMax = Math.round(data.daily.temperature_2m_max[0]);
            const code = data.daily.weathercode[0];
            
            // ç°¡æ˜“åœ–ç¤ºè½‰æ›
            let icon = 'â˜ï¸';
            if(code <= 3) icon = 'â˜€ï¸';
            else if(code <= 60) icon = 'ğŸŒ§ï¸';
            else if(code <= 80) icon = 'â˜”';
            
            const el = document.getElementById(elementId);
            if(el) el.innerHTML = `${icon} ${tempMin}-${tempMax}Â°C`;
        } catch(e) {
            const el = document.getElementById(elementId);
            if(el) el.innerHTML = '';
        }
    }

    function getLiveWeather() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                    const data = await res.json();
                    document.getElementById('currentWeather').innerHTML = 
                        `<i class="fa-solid fa-location-arrow"></i> ç›®å‰ä½ç½® ${Math.round(data.current_weather.temperature)}Â°C`;
                } catch(e) {}
            });
        }
    }

    // --- Utils ---
    function showMc(code) {
        document.getElementById('modalMc').innerText = code;
        document.getElementById('mcModal').style.display = 'flex';
    }

    function searchNearby(keyword) {
        window.open(`https://www.google.com/maps/search/${keyword}`, '_blank');
    }

    init();
</script>

</body>
</html>
